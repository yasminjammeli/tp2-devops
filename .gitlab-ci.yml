image: docker:24

services:
  - docker:24-dind

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1"

stages:
  - build_push
  - scan

# Ancre pour rÃ©utiliser la commande de login Docker
.docker_login: &docker_login
  - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin

# Build et Push du serveur
build_push_server:
  stage: build_push
  rules:
    - changes:
        - "server/**/*"
  script:
    - *docker_login
    - docker build -t "$DOCKERHUB_USER/mern-server:$CI_COMMIT_SHORT_SHA" server
    - docker push "$DOCKERHUB_USER/mern-server:$CI_COMMIT_SHORT_SHA"
    - echo "Server image pushed successfully"

# Scan du serveur avec Trivy
scan_server:
  stage: scan
  rules:
    - changes:
        - "server/**/*"
  script:
    - docker pull "$DOCKERHUB_USER/mern-server:$CI_COMMIT_SHORT_SHA"
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image "$DOCKERHUB_USER/mern-server:$CI_COMMIT_SHORT_SHA" > trivy_server_report.txt
    - cat trivy_server_report.txt
  artifacts:
    paths:
      - trivy_server_report.txt
    expire_in: 1 week
  allow_failure: true

# Build et Push du client
build_push_client:
  stage: build_push
  rules:
    - changes:
        - "client/**/*"
  script:
    - *docker_login
    - docker build -t "$DOCKERHUB_USER/mern-client:$CI_COMMIT_SHORT_SHA" client
    - docker push "$DOCKERHUB_USER/mern-client:$CI_COMMIT_SHORT_SHA"
    - echo "Client image pushed successfully"

# Scan du client avec Trivy
scan_client:
  stage: scan
  rules:
    - changes:
        - "client/**/*"
  script:
    - docker pull "$DOCKERHUB_USER/mern-client:$CI_COMMIT_SHORT_SHA"
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image "$DOCKERHUB_USER/mern-client:$CI_COMMIT_SHORT_SHA" > trivy_client_report.txt
    - cat trivy_client_report.txt
  artifacts:
    paths:
      - trivy_client_report.txt
    expire_in: 1 week
  allow_failure: true